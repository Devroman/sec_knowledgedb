# Websocket

**Websocket** - протокол полнодуплексной связи. Позволяет общаться клиенту и серверу, удерживая постоянное [**TCP**](../networks/iso_osi.md) соединение. Позволяет передавать xml, json и даже бинарные данные(blob).  

**Websocket** достаточно молодая технология - [RFC](../glossary.md) опубликован в конце 2011г.

Поддерживает как простую работу через протокол **ws**, так и по шифрованному соединению **wss**.  

## Установление соединения и механизм работы

1. Клиент делает **http** запрос с заголовками `Upgrade: websocket` и `Connection: Upgrade`
2. Сервер отвечает с теми же заголовками и статусом *101 (Switching Protocols)*
3. После этого соединение устанавливается на отдельном порту и **http** больше не используется

Пример:  
запрос  

    GET /chat HTTP/1.1
    Host: server.example.com
    Upgrade: websocket
    Connection: Upgrade
    Origin: http://example.com
    Sec-WebSocket-Key: Lasdnl23bnKB==
    Sec-WebSocket-Version: 13

ответ  

    HTTP/1.1 101 Switching Protocols
    Upgrade: websocket
    Connection: Upgrade
    Sec-WebSocket-Accept: hsBlbuDTkk24srzEOTBUlZAlC2g=

* `Sec-WebSocket-Key` - случайный ключ в BASE64
* `Sec-WebSocket-Version` - версия протокола
* `Sec-WebSocket-Accept` - перекодированный ключ

Используются для аналога "тройного рукопожатия" протокола [**TCP**](../networks/iso_osi.md)  

> Подставить эти заголовки через **XMLHttpRequest** невозможно.

После этого идет обмен двумя видами фреймов: с данными и управляющими. Последние используются для проверки связи и закрытия соединения.  

## Использование в JS

    var socket = new WebSocket("ws://example.com/ws");

Также есть возможность назначить обработчики:

* `socket.onopen` - установление соединения
* `socket.onclose` - закрытие соединения
* `socket.onmessage` - получение сообщения
* `socket.onerror` - ошибка

## Механизмы WS

### PING PONG

В любой момент каждая из сторон может отправить фрейм **PING** ожидая получить за приемлемое время ответ **PONG**. Управлять этим из **JS** нельзя.

### Отправка фрагмента

Данные могут быть разделены фактически на несколько фреймов. Последний должен содержать бит, соответствующий окончанию передачи.

## Важно запомнить

Что соединение устанавливается **http**-запросом при помощи метода **GET**.  

[← Назад](../README.md)